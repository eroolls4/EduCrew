@model IEnumerable<EduCrew.Models.Post>

@using Microsoft.AspNet.Identity;

<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <a href="@Url.Action("Create", "Posts")" class="btn btn-primary">Create New</a>
        </div>
    </div>

    <!-- Search bar -->
    <div class="row mb-4">
        <div class="col-md-12">
            <input type="text" id="searchInput" class="form-control" placeholder="Search posts by title or content">
        </div>
    </div>

    <div id="postList" class="list-group">
        @foreach (var post in Model)
        {
            <div id="postContainer-@post.PostId" class="list-group-item" data-post-id="@post.PostId">
                <div class="row">
                    <div class="col-md-1">
                        <!-- Profile Image -->
                        <img src="@post.User.ProfileImage" alt="Profile" class="img-thumbnail rounded-circle" style="width: 50px; height: 50px;">
                    </div>
                    <div class="col-md-9">
                        <!-- Post Information -->
                        <h5 class="post-title">@post.Title</h5>
                        <p class="text-muted post-content">
                            Posted by @post.User.UserName on @post.DatePosted.ToString("MMMM dd, yyyy") |
                            Category: <span class="badge badge-info text-bg-success">@post.Category.Name</span>
                        </p>
                    </div>
                    <div class="col-md-2 text-right">
                        <!-- Action Links (Visible only to Admins) -->
                        @if (User.IsInRole("Admin"))
                        {
                            <button data-post-id="@post.PostId" class="btn-link js-delete">Delete</button>
                        }
                        @if (post.UserId == HttpContext.Current.User.Identity.GetUserId())
                        {
                            <a href="@Url.Action("Edit", new { id = post.PostId })" class="btn btn-sm btn-secondary">Edit</a>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Preparing the data for Fuse.js

        // Delete post using Ajax and SweetAlert2 confirmation
        $(".js-delete").on("click", function (event) {
            event.stopPropagation();

            var button = $(this);
            var postId = button.attr("data-post-id");

            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to delete this post?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "/api/PostAPI/" + postId,
                        method: "DELETE",
                        success: function () {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: 'Your post has been deleted.',
                                confirmButtonColor: '#3085d6',
                                timer: 2500
                            });
                            button.closest(".list-group-item").remove();
                        },
                        error: function (err) {
                            console.error("Error deleting post: ", err);
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Something went wrong!',
                                confirmButtonColor: '#d33'
                            });
                        }
                    });
                }
            });
        });
    </script>
}
